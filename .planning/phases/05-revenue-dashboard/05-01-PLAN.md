---
phase: 05-revenue-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/telegram-bot/src/services/stripe.ts
  - apps/telegram-bot/src/services/revenue.ts
autonomous: true

must_haves:
  truths:
    - "Stripe charges can be retrieved for any date range"
    - "Revenue totals are calculated correctly (cents to dollars conversion)"
    - "Pagination handles months with >100 charges"
    - "Currency is formatted as $1,234.56 with proper locale"
    - "Monthly goal progress shows visual indicator"
  artifacts:
    - path: "apps/telegram-bot/src/services/stripe.ts"
      provides: "Stripe API wrapper with date-filtered charge retrieval"
      exports: ["getSuccessfulCharges", "getTodayRevenue", "getWeekRevenue", "getMonthRevenue", "getYearRevenue"]
    - path: "apps/telegram-bot/src/services/revenue.ts"
      provides: "Currency formatting and revenue response generation"
      exports: ["formatCurrency", "formatRevenueResponse"]
  key_links:
    - from: "apps/telegram-bot/src/services/stripe.ts"
      to: "Stripe API"
      via: "stripe.charges.list() with created filter"
      pattern: "stripe\\.charges\\.list"
    - from: "apps/telegram-bot/src/services/revenue.ts"
      to: "Intl.NumberFormat"
      via: "Currency formatting"
      pattern: "Intl\\.NumberFormat"
---

<objective>
Create Stripe integration and revenue formatting services for revenue queries.

Purpose: Establish the core infrastructure for retrieving payment data from Stripe and formatting revenue responses. This enables Kimmie to see her revenue in Telegram and on the dashboard.

Output: Two services - stripe.ts for Stripe API access with pagination, revenue.ts for currency formatting and goal progress visualization.
</objective>

<execution_context>
@/home/bitvise/.claude/get-shit-done/workflows/execute-plan.md
@/home/bitvise/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-revenue-dashboard/05-RESEARCH.md

Key patterns from research:
- Stripe Charges API with created[gte]/created[lte] for date filtering
- Must handle pagination (max 100 per request) with has_more and starting_after
- Filter for status=succeeded, livemode=true, refunded=false
- date-fns startOf/endOf for timezone-safe date boundaries
- Intl.NumberFormat for currency formatting
- Unicode block characters for progress bar (works in Telegram)
- MONTHLY_REVENUE_GOAL env var defaults to 9000
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe SDK</name>
  <files>apps/telegram-bot/package.json</files>
  <action>
Install Stripe Node.js SDK in the telegram-bot workspace:

```bash
npm install stripe --workspace=@looking-glass/telegram-bot
```

This adds the official Stripe SDK with TypeScript support.
  </action>
  <verify>Check package.json includes "stripe" dependency</verify>
  <done>stripe package appears in apps/telegram-bot/package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create Stripe service with date-filtered charge retrieval</name>
  <files>apps/telegram-bot/src/services/stripe.ts</files>
  <action>
Create apps/telegram-bot/src/services/stripe.ts with:

1. Stripe client initialization with STRIPE_SECRET_KEY env var
2. getSuccessfulCharges(startDate, endDate) function:
   - Convert dates to Unix timestamps for Stripe API
   - Handle pagination with while loop (has_more + starting_after)
   - Filter charges: status === 'succeeded', !refunded, livemode === true
   - Return array of Stripe.Charge objects

3. Revenue calculation functions:
   - getTodayRevenue(): uses startOfDay/endOfDay
   - getWeekRevenue(): uses startOfWeek/endOfWeek (weekStartsOn: 0 for Sunday)
   - getMonthRevenue(): uses startOfMonth/endOfMonth
   - getYearRevenue(): uses startOfYear/endOfYear
   - All return Promise<number> (dollars, not cents)

4. Internal calculateRevenue helper that sums charge.amount / 100

Use date-fns for date boundaries (already installed). Reference 05-RESEARCH.md Pattern 1 and Pattern 2.
  </action>
  <verify>TypeScript compiles without errors: cd apps/telegram-bot && npx tsc --noEmit</verify>
  <done>stripe.ts exports getSuccessfulCharges, getTodayRevenue, getWeekRevenue, getMonthRevenue, getYearRevenue</done>
</task>

<task type="auto">
  <name>Task 3: Create revenue formatting service with goal progress</name>
  <files>apps/telegram-bot/src/services/revenue.ts</files>
  <action>
Create apps/telegram-bot/src/services/revenue.ts with:

1. formatCurrency(amount, currency = 'USD') function:
   - Use Intl.NumberFormat('en-US', { style: 'currency', currency })
   - Returns formatted string like "$1,234.56"

2. formatRevenueResponse(period, revenue, goal?) function:
   - period: 'today' | 'week' | 'month' | 'year'
   - Emoji mapping: today = calendar, week = chart, month = money bag, year = target
   - Label mapping: "Today's Revenue", "This Week's Revenue", etc.
   - Base message: "{emoji} {label}: {formatted revenue}"
   - For month period with goal:
     - Calculate percentage (min 100%)
     - Create progress bar with filled blocks and empty blocks (10 chars total)
     - Add goal line: "Goal: $9,000.00 (XX.X%)"
     - Add motivational message: "Goal reached!" or "$X to go!"

Reference 05-RESEARCH.md Pattern 4 and Pattern 5 for exact formatting.
  </action>
  <verify>TypeScript compiles without errors: cd apps/telegram-bot && npx tsc --noEmit</verify>
  <done>revenue.ts exports formatCurrency and formatRevenueResponse, monthly goal shows progress bar</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd apps/telegram-bot && npx tsc --noEmit` passes
2. Stripe service exports all 5 functions (getSuccessfulCharges + 4 period functions)
3. Revenue service exports formatCurrency and formatRevenueResponse
4. formatRevenueResponse('month', 5000, 9000) produces progress bar output
</verification>

<success_criteria>
1. Stripe SDK installed in telegram-bot package
2. stripe.ts can query Stripe Charges API with date filtering and pagination
3. revenue.ts formats currency and generates goal progress for monthly revenue
4. All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-revenue-dashboard/05-01-SUMMARY.md`
</output>
