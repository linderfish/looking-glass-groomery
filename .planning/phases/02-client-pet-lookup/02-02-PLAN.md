---
phase: 02-client-pet-lookup
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/telegram-bot/src/services/formatting.ts
  - apps/telegram-bot/src/handlers/lookup.ts
autonomous: true

must_haves:
  truths:
    - "Kimmie taps a pet name and sees complete pet profile"
    - "Pet profile shows photo, age, breed, spayed status"
    - "Pet profile shows spicy meter with pepper emojis"
    - "Pet profile shows preferences and allergies from passport"
  artifacts:
    - path: "apps/telegram-bot/src/services/formatting.ts"
      provides: "Pet profile formatting with spicy meter"
      exports: ["formatPetProfile", "formatSpicyMeter", "calculateAge"]
    - path: "apps/telegram-bot/src/handlers/lookup.ts"
      provides: "Pet profile callback handler"
      contains: "callbackQuery(/^pet:/"
  key_links:
    - from: "apps/telegram-bot/src/handlers/lookup.ts"
      to: "prisma.pet"
      via: "findUnique with passport include"
      pattern: "prisma\\.pet\\.findUnique"
    - from: "apps/telegram-bot/src/handlers/lookup.ts"
      to: "apps/telegram-bot/src/services/formatting.ts"
      via: "import formatPetProfile"
      pattern: "formatPetProfile"
---

<objective>
Add complete pet profile display with photo, demographics, spicy meter, and passport details when Kimmie taps a pet button.

Purpose: Give Kimmie all the critical pet information she needs at a glance - especially the spicy meter (1-3 peppers) which tells her how careful to be.

Output: Tapping a pet name shows rich profile with all pet details including temperament visualization.
</objective>

<execution_context>
@/home/bitvise/.claude/get-shit-done/workflows/execute-plan.md
@/home/bitvise/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/bitvise/projects/kimmie/.planning/PROJECT.md
@/home/bitvise/projects/kimmie/.planning/ROADMAP.md
@/home/bitvise/projects/kimmie/.planning/STATE.md
@/home/bitvise/projects/kimmie/.planning/phases/02-client-pet-lookup/02-RESEARCH.md

# Prior plan output (use patterns from this)
@/home/bitvise/projects/kimmie/.planning/phases/02-client-pet-lookup/02-01-PLAN.md

# Schema reference for Pet and PetPassport models
@/home/bitvise/projects/kimmie/packages/db/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pet profile formatting with spicy meter and age calculation</name>
  <files>
    apps/telegram-bot/src/services/formatting.ts
  </files>
  <action>
Add to `apps/telegram-bot/src/services/formatting.ts`:

1. `calculateAge(birthDate: Date | null): string`
   - If null: return "Unknown"
   - Calculate years and months from birthDate to now
   - Return "X years" or "X months" for puppies < 1 year

2. `formatSpicyMeter(temperament: Temperament): string`
   - Map Kimmie's mental model (1-3 peppers based on danger level):
     ```typescript
     const spicyMap: Record<Temperament, string> = {
       NORMAL: '',  // No peppers - chill pup
       PUPPY: '',   // No peppers - just wiggly
       SENIOR: '',  // No peppers - old and calm
       SERVICE_ANIMAL: '',  // No peppers - trained
       NURSING: '(nursing mom)',  // Note, not spicy
       ANXIOUS: '1/3 spicy',     // Might nip
       FEARFUL: '2/3 spicy',     // Will try to bite
       AGGRESSIVE: '3/3 SPICY',  // Actively dangerous
     }
     ```
   - Return formatted string with visual indicator

3. `formatPetProfile(pet: Pet & { passport?: PetPassport | null, client: Client }): string`
   - HTML formatted pet profile:
     ```
     <b>PET_EMOJI PET_NAME</b>
     Owner: CLIENT_NAME

     Species: SPECIES
     Breed: BREED or "Mixed"
     Age: CALCULATED_AGE
     Sex: MALE/FEMALE/Unknown
     Fixed: Yes/No

     [SPICY_METER if not empty]

     [If passport exists:]
     <b>Preferences:</b>
     SPECIAL_INSTRUCTIONS or "None noted"

     <b>Allergies:</b>
     ALLERGIES or "None noted"

     [If behaviorNotes:]
     <b>Behavior Notes:</b>
     BEHAVIOR_NOTES
     ```
   - Use species emoji: DOG=, CAT=, GOAT=, PIG=, GUINEA_PIG=
   - Show spicy meter prominently if pet is ANXIOUS, FEARFUL, or AGGRESSIVE
  </action>
  <verify>
    - TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`
    - Exports are available: Check file exports calculateAge, formatSpicyMeter, formatPetProfile
  </verify>
  <done>
    - calculateAge handles null birthDate and calculates years/months
    - formatSpicyMeter maps temperament to Kimmie's pepper system
    - formatPetProfile returns complete HTML profile with all fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pet profile callback handler to lookup.ts</name>
  <files>
    apps/telegram-bot/src/handlers/lookup.ts
  </files>
  <action>
Add to `apps/telegram-bot/src/handlers/lookup.ts`:

1. Import formatPetProfile, formatSpicyMeter from formatting.ts

2. Add callback handler for pet profile:
   ```typescript
   lookupHandler.callbackQuery(/^pet:(.+)$/, async (ctx) => {
     const petId = ctx.match[1]

     // CRITICAL: Answer callback immediately (10 second limit)
     await ctx.answerCallbackQuery()

     const pet = await prisma.pet.findUnique({
       where: { id: petId },
       include: {
         client: true,
         passport: true,  // Includes allergies, specialInstructions
       },
     })

     if (!pet) {
       await ctx.reply('Pet not found')
       return
     }

     const message = formatPetProfile(pet)

     // Build buttons: back to client, visit history
     const buttons = [
       [{ text: ' Back to Client', callback_data: `client:${pet.clientId}` }],
       [{ text: ' Visit History', callback_data: `pethistory:${pet.id}` }],
     ]

     // If pet has photo, send as photo message; otherwise text
     if (pet.photoUrl) {
       try {
         await ctx.replyWithPhoto(pet.photoUrl, {
           caption: message,
           parse_mode: 'HTML',
           reply_markup: { inline_keyboard: buttons },
         })
       } catch {
         // Photo URL might be broken - fall back to text
         await ctx.reply(message, {
           parse_mode: 'HTML',
           reply_markup: { inline_keyboard: buttons },
         })
       }
     } else {
       await ctx.reply(message, {
         parse_mode: 'HTML',
         reply_markup: { inline_keyboard: buttons },
       })
     }
   })
   ```

3. Remove old message reply_markup when showing new profile (to prevent button confusion):
   - Add `await ctx.editMessageReplyMarkup({ reply_markup: undefined }).catch(() => {})` before showing new profile
  </action>
  <verify>
    - TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`
    - Bot starts: `cd apps/telegram-bot && timeout 5s npm run dev || true`
    - In Telegram: After /lookup finds a client, tapping pet button shows pet profile
    - Pet profile shows age, breed, fixed status
    - Spicy pets show pepper warning (if any ANXIOUS/FEARFUL/AGGRESSIVE pets exist in DB)
  </verify>
  <done>
    - Callback handler `pet:(.+)` loads pet with passport and formats profile
    - Pet photo displays if available
    - Spicy meter shows for dangerous temperaments
    - Passport preferences and allergies display
    - Back to Client button navigates correctly
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. /lookup finds a client
2. Tapping a pet button shows the pet's complete profile
3. Profile shows: photo (if exists), name, species, breed, age, sex, fixed status
4. Spicy pets show 1-3 pepper warning based on temperament
5. Passport allergies and preferences show if pet has passport
6. "Back to Client" button returns to client profile
</verification>

<success_criteria>
- LOOKUP-04: Pet profile shows photo, age, breed, spayed status - All fields display correctly
- LOOKUP-05: Pet profile shows spicy meter (1-3 peppers) - Temperament mapped to peppers
- LOOKUP-06: Pet profile shows grooming preferences and allergies - Passport data displays
</success_criteria>

<output>
After completion, create `.planning/phases/02-client-pet-lookup/02-02-SUMMARY.md`
</output>
