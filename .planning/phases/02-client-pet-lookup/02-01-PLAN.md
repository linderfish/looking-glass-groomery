---
phase: 02-client-pet-lookup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/telegram-bot/src/services/search.ts
  - apps/telegram-bot/src/services/formatting.ts
  - apps/telegram-bot/src/handlers/lookup.ts
  - apps/telegram-bot/src/handlers/index.ts
  - apps/telegram-bot/src/index.ts
  - packages/db/prisma/migrations/*/migration.sql
autonomous: true

must_haves:
  truths:
    - "Kimmie types a client name and sees matching client profiles"
    - "Kimmie types a phone number and sees the matching client profile"
    - "Client profile shows all pets with summary"
  artifacts:
    - path: "apps/telegram-bot/src/services/search.ts"
      provides: "Client search by name and phone"
      exports: ["searchClientsByName", "searchClientByPhone", "normalizePhone"]
    - path: "apps/telegram-bot/src/services/formatting.ts"
      provides: "Telegram message formatting for profiles"
      exports: ["formatClientProfile", "formatClientList"]
    - path: "apps/telegram-bot/src/handlers/lookup.ts"
      provides: "Telegram lookup command handler"
      exports: ["lookupHandler"]
  key_links:
    - from: "apps/telegram-bot/src/handlers/lookup.ts"
      to: "apps/telegram-bot/src/services/search.ts"
      via: "import searchClientsByName, searchClientByPhone"
      pattern: "searchClients"
    - from: "apps/telegram-bot/src/handlers/lookup.ts"
      to: "apps/telegram-bot/src/services/formatting.ts"
      via: "import formatClientProfile"
      pattern: "formatClient"
    - from: "apps/telegram-bot/src/index.ts"
      to: "apps/telegram-bot/src/handlers/lookup.ts"
      via: "bot.use(lookupHandler)"
      pattern: "lookupHandler"
---

<objective>
Implement core client search infrastructure and Telegram lookup command with client profile display.

Purpose: Enable Kimmie to search for clients by name or phone number and see their profile with pets - the foundation for all lookup functionality.

Output: Working /lookup command that searches clients and displays profiles with pet buttons.
</objective>

<execution_context>
@/home/bitvise/.claude/get-shit-done/workflows/execute-plan.md
@/home/bitvise/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/bitvise/projects/kimmie/.planning/PROJECT.md
@/home/bitvise/projects/kimmie/.planning/ROADMAP.md
@/home/bitvise/projects/kimmie/.planning/STATE.md
@/home/bitvise/projects/kimmie/.planning/phases/02-client-pet-lookup/02-RESEARCH.md

# Existing patterns to follow
@/home/bitvise/projects/kimmie/apps/telegram-bot/src/handlers/bookings.ts
@/home/bitvise/projects/kimmie/apps/telegram-bot/src/bot.ts
@/home/bitvise/projects/kimmie/packages/db/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search service with phone normalization and fuzzy name search</name>
  <files>
    apps/telegram-bot/src/services/search.ts
    packages/db/prisma/migrations/*/migration.sql
  </files>
  <action>
1. Install libphonenumber-js in apps/telegram-bot: `npm install libphonenumber-js`

2. Create `apps/telegram-bot/src/services/search.ts` with:
   - `normalizePhone(input: string): string | null` - Parse phone using libphonenumber-js with 'US' default, return E.164 format or null
   - `searchClientByPhone(phone: string)` - Normalize input, query prisma.client.findFirst with `phone: normalizedPhone`, include pets
   - `searchClientsByName(query: string, limit = 10)` - Use Prisma ILIKE with `contains` and `mode: 'insensitive'` on firstName OR lastName, include pets, return up to limit results

3. Create PostgreSQL migration to enable pg_trgm and add GIN indexes:
   ```sql
   CREATE EXTENSION IF NOT EXISTS pg_trgm;
   CREATE INDEX IF NOT EXISTS idx_client_fname_trgm ON "Client" USING GIN (LOWER("firstName") gin_trgm_ops);
   CREATE INDEX IF NOT EXISTS idx_client_lname_trgm ON "Client" USING GIN (LOWER("lastName") gin_trgm_ops);
   ```
   Run via: `cd packages/db && npx prisma migrate dev --name add_trgm_indexes`

4. Export all functions from search.ts
  </action>
  <verify>
    - `cd apps/telegram-bot && npm ls libphonenumber-js` shows installed
    - TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`
    - Migration applied: Check `packages/db/prisma/migrations/` for new migration folder
  </verify>
  <done>
    - libphonenumber-js installed
    - search.ts exports normalizePhone, searchClientByPhone, searchClientsByName
    - pg_trgm extension enabled and GIN indexes created on Client table
  </done>
</task>

<task type="auto">
  <name>Task 2: Create formatting service and lookup handler with /lookup command</name>
  <files>
    apps/telegram-bot/src/services/formatting.ts
    apps/telegram-bot/src/handlers/lookup.ts
    apps/telegram-bot/src/handlers/index.ts
    apps/telegram-bot/src/index.ts
  </files>
  <action>
1. Create `apps/telegram-bot/src/services/formatting.ts`:
   - `formatClientProfile(client: Client & { pets: Pet[] }): string` - HTML formatted profile:
     ```
     <b>CLIENT_NAME</b>

     PHONE (as <code>)
     EMAIL (if exists)
     Membership: TIER

     <b>Pets (N):</b>
     - PetName (Species, Breed)
     ```
   - `formatClientList(clients: (Client & { pets: Pet[] })[]): string` - Numbered list of clients for multiple matches

2. Create `apps/telegram-bot/src/handlers/lookup.ts`:
   - Import Composer from grammy, BotContext from ../bot
   - Import search functions and formatting functions
   - Export `lookupHandler = new Composer<BotContext>()`

   - `/lookup [query]` command:
     - If no query: Reply with usage instructions (name or phone examples)
     - Check if query looks like phone (regex for digits)
     - If phone: searchClientByPhone, show single profile or "not found"
     - If name: searchClientsByName
       - 0 results: "No clients found"
       - 1 result: Show profile with pet buttons
       - 2+ results: Show client list with selection buttons

   - Client profile buttons:
     ```typescript
     const buttons = client.pets.map(pet => ([
       { text: `PET_EMOJI ${pet.name}`, callback_data: `pet:${pet.id}` }
     ]))
     buttons.push([{ text: 'Visit History', callback_data: `history:${client.id}` }])
     ```

   - Callback handler `client:(.+)` - Load client by ID, show profile (for list selection)
   - Use HTML parse_mode for all messages

3. Update `apps/telegram-bot/src/handlers/index.ts`:
   - Add export: `export { lookupHandler } from './lookup'`

4. Update `apps/telegram-bot/src/index.ts`:
   - Import lookupHandler
   - Add `bot.use(lookupHandler)` AFTER session middleware but BEFORE help handler (to ensure proper handler priority)
  </action>
  <verify>
    - TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`
    - Bot starts without error: `cd apps/telegram-bot && timeout 5s npm run dev || true` (expect clean startup, timeout is fine)
    - In Telegram: `/lookup` shows usage instructions
    - In Telegram: `/lookup Sarah` returns matching clients (if any exist in DB)
  </verify>
  <done>
    - formatting.ts exports formatClientProfile, formatClientList
    - lookup.ts exports lookupHandler with /lookup command
    - Bot registers lookupHandler and responds to /lookup
    - Client profiles display with pet buttons
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `/lookup` shows usage help
2. `/lookup [phone]` finds client by phone (test with known phone in DB)
3. `/lookup [name]` finds clients by name
4. Multiple matches show selection list
5. Single match shows profile with pet buttons
6. Tapping a client in list shows their profile
</verification>

<success_criteria>
- LOOKUP-01: Search clients by name - /lookup name works
- LOOKUP-02: Search clients by phone - /lookup phone works
- LOOKUP-03: Client profile shows all pets - Profile displays pet list with buttons
</success_criteria>

<output>
After completion, create `.planning/phases/02-client-pet-lookup/02-01-SUMMARY.md`
</output>
