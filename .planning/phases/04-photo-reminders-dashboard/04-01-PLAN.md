---
phase: 04-photo-reminders-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/telegram-bot/src/services/photo-upload.ts
  - apps/telegram-bot/src/handlers/photos.ts
  - apps/telegram-bot/src/handlers/index.ts
  - apps/telegram-bot/src/index.ts
autonomous: true
user_setup:
  - service: aws-s3
    why: "Store groom photos permanently"
    env_vars:
      - name: AWS_REGION
        source: "AWS Console - your preferred region (e.g., us-west-2)"
      - name: AWS_ACCESS_KEY_ID
        source: "AWS Console -> IAM -> Users -> Security credentials"
      - name: AWS_SECRET_ACCESS_KEY
        source: "AWS Console -> IAM -> Users -> Security credentials"
      - name: S3_BUCKET
        source: "AWS Console -> S3 -> Create bucket (e.g., looking-glass-photos)"
    dashboard_config:
      - task: "Create S3 bucket with public read access for photos"
        location: "AWS Console -> S3 -> Create bucket"

must_haves:
  truths:
    - "Photo sent to Telegram uploads to S3 and shows Before/After selection"
    - "Selecting Before or After saves photo to appointment"
    - "Photo URL persists in database (not Telegram's temporary URL)"
  artifacts:
    - path: "apps/telegram-bot/src/services/photo-upload.ts"
      provides: "S3 upload and appointment attachment logic"
      exports: ["uploadPhotoToS3", "findCurrentAppointment", "attachPhotoToAppointment"]
    - path: "apps/telegram-bot/src/handlers/photos.ts"
      provides: "Telegram photo handler with inline keyboard"
      exports: ["photosHandler"]
  key_links:
    - from: "apps/telegram-bot/src/handlers/photos.ts"
      to: "apps/telegram-bot/src/services/photo-upload.ts"
      via: "import and call uploadPhotoToS3, findCurrentAppointment"
      pattern: "uploadPhotoToS3|findCurrentAppointment"
    - from: "apps/telegram-bot/src/handlers/photos.ts"
      to: "prisma.appointmentPhoto"
      via: "database write after Before/After selection"
      pattern: "prisma\\.appointmentPhoto\\.create"
---

<objective>
Enable Kimmie to send photos via Telegram that are saved to S3 and attached to appointments with Before/After marking.

Purpose: Core functionality - every groom needs photos saved reliably (not on Telegram's expiring URLs).
Output: Photo upload service, photo handler with inline keyboard for type selection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-photo-reminders-dashboard/04-RESEARCH.md

# Existing infrastructure
@apps/telegram-bot/src/bot.ts
@apps/telegram-bot/src/handlers/voice.ts
@apps/telegram-bot/src/handlers/index.ts
@apps/telegram-bot/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create photo upload service</name>
  <files>apps/telegram-bot/src/services/photo-upload.ts</files>
  <action>
Create photo-upload.ts with three functions:

1. `uploadPhotoToS3(filePath: string, fileId: string): Promise<string>`:
   - Use @aws-sdk/client-s3 (already installed)
   - S3 key format: `photos/{timestamp}-{fileId}.jpg`
   - ContentType: 'image/jpeg'
   - Return full S3 URL: `https://{bucket}.s3.amazonaws.com/{key}`
   - Always unlink temp file in finally block

2. `findCurrentAppointment(): Promise<string | null>`:
   - Priority order (as specified in RESEARCH.md):
     - IN_PROGRESS today (most likely current groom)
     - CHECKED_IN today (next up)
     - CONFIRMED today in future (scheduled for later)
     - COMPLETED today most recent (just finished, after hours)
   - Use startOfDay/endOfDay from date-fns
   - Return appointment ID or null

3. `attachPhotoToAppointment(appointmentId: string, type: 'BEFORE' | 'AFTER', photoUrl: string): Promise<void>`:
   - Create AppointmentPhoto record via prisma
   - Set status to 'PENDING_REVIEW'

Import patterns from voice.ts for file handling. Use existing prisma import from @looking-glass/db.
  </action>
  <verify>TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`</verify>
  <done>photo-upload.ts exports uploadPhotoToS3, findCurrentAppointment, attachPhotoToAppointment</done>
</task>

<task type="auto">
  <name>Task 2: Create photo handler with Before/After keyboard</name>
  <files>apps/telegram-bot/src/handlers/photos.ts, apps/telegram-bot/src/handlers/index.ts, apps/telegram-bot/src/index.ts</files>
  <action>
Create photos.ts handler following the pattern from voice.ts:

1. Create Composer-based handler:
   ```typescript
   import { Composer, InlineKeyboard } from 'grammy';
   import type { BotContext } from '../bot';
   ```

2. Handle `message:photo` event:
   - Show typing indicator
   - Get largest photo: `ctx.message.photo[ctx.message.photo.length - 1]`
   - Download via hydrateFiles: `const file = await ctx.getFile(); const filePath = await file.download();`
   - Use @ts-expect-error for download() (same pattern as voice.ts)
   - Call uploadPhotoToS3() to save to S3
   - Call findCurrentAppointment() to get appointment ID
   - If no appointment found, reply "Photo saved! But couldn't find a current appointment."
   - If appointment found, show InlineKeyboard with Before/After buttons:
     - Button format: `photo:before:{appointmentId}` and `photo:after:{appointmentId}`
   - Store photoUrl in callback data (URL-encode if needed) OR store in session temporarily

3. Handle callback queries with regex `/^photo:(before|after):(.+)$/`:
   - Extract type and appointmentId from match
   - Call attachPhotoToAppointment()
   - Call ctx.answerCallbackQuery({ text: 'Saved!' })
   - Call ctx.editMessageText() to confirm: "BEFORE/AFTER photo saved!"

4. Add catch-all callback handler to prevent loading animations:
   ```typescript
   photosHandler.on('callback_query:data', async (ctx) => {
     await ctx.answerCallbackQuery();
   });
   ```

5. Export from handlers/index.ts: `export { photosHandler } from './photos'`

6. Register in index.ts:
   - Add to imports: `photosHandler`
   - Add before bookingsHandler: `bot.use(photosHandler)` (photos should be processed before generic handlers)
  </action>
  <verify>
1. TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`
2. Handler exports correctly: `grep -n "photosHandler" apps/telegram-bot/src/handlers/index.ts`
3. Handler registered: `grep -n "photosHandler" apps/telegram-bot/src/index.ts`
  </verify>
  <done>Sending a photo to the bot shows Before/After inline keyboard; selecting one saves to database</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. photosHandler is exported from handlers/index.ts
3. photosHandler is registered in index.ts before bookingsHandler
4. photo-upload.ts has all three exported functions
</verification>

<success_criteria>
- Photo upload flow: Telegram photo -> S3 upload -> Before/After selection -> Database save
- No temp file disk bloat (files cleaned up after S3 upload)
- Graceful handling when no current appointment found
</success_criteria>

<output>
After completion, create `.planning/phases/04-photo-reminders-dashboard/04-01-SUMMARY.md`
</output>
