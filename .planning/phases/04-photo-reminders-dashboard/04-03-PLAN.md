---
phase: 04-photo-reminders-dashboard
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/telegram-bot/src/routes/dashboard.ts
  - apps/telegram-bot/src/index.ts
  - apps/telegram-bot/package.json
autonomous: true
user_setup:
  - service: dashboard-password
    why: "Protect dashboard from public access"
    env_vars:
      - name: DASHBOARD_PASSWORD
        source: "Choose a simple password for dashboard access (e.g., 'lookinglass')"

must_haves:
  truths:
    - "Web dashboard shows today's schedule at /dashboard/today"
    - "Dashboard requires password authentication"
    - "Client search returns matching clients and their pets"
    - "Dashboard is mobile-friendly"
  artifacts:
    - path: "apps/telegram-bot/src/routes/dashboard.ts"
      provides: "Express routes for web dashboard with basic auth"
      exports: ["dashboardRouter"]
  key_links:
    - from: "apps/telegram-bot/src/index.ts"
      to: "apps/telegram-bot/src/routes/dashboard.ts"
      via: "import and mount dashboardRouter"
      pattern: "dashboardRouter|/dashboard"
    - from: "apps/telegram-bot/src/routes/dashboard.ts"
      to: "prisma.client"
      via: "database query for client search"
      pattern: "prisma\\.client\\.(findMany|findFirst)"
---

<objective>
Create a simple web dashboard for Kimmie to view today's schedule and search clients from any device.

Purpose: Schedule visibility without opening Telegram - quick glance at appointments from phone browser.
Output: Express routes with basic auth for /dashboard/today and /dashboard/search.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-photo-reminders-dashboard/04-RESEARCH.md
@.planning/phases/04-photo-reminders-dashboard/04-CONTEXT.md

# Existing infrastructure
@apps/telegram-bot/src/index.ts
@apps/telegram-bot/src/services/daily-digest.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install express-basic-auth dependency</name>
  <files>apps/telegram-bot/package.json</files>
  <action>
Add express-basic-auth to the telegram-bot package:

```bash
cd apps/telegram-bot && npm install express-basic-auth
```

This provides simple password protection for the dashboard without complex auth flows.
Note: Express is already a dependency in the monorepo (used by cheshire app).
  </action>
  <verify>Check package.json: `grep "express-basic-auth" apps/telegram-bot/package.json`</verify>
  <done>express-basic-auth is listed in telegram-bot dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard routes with basic auth</name>
  <files>apps/telegram-bot/src/routes/dashboard.ts</files>
  <action>
Create dashboard.ts with Express router:

1. Setup with basic auth protection:
   ```typescript
   import { Router } from 'express';
   import basicAuth from 'express-basic-auth';
   import { prisma } from '@looking-glass/db';
   import { startOfDay, endOfDay, format } from 'date-fns';

   export const dashboardRouter = Router();

   // Protect all dashboard routes
   dashboardRouter.use(basicAuth({
     users: { 'kimmie': process.env.DASHBOARD_PASSWORD || 'lookinglass' },
     challenge: true,
     realm: 'Looking Glass Dashboard'
   }));
   ```

2. Create GET /today route:
   - Query today's appointments (CONFIRMED, PENDING, CHECKED_IN, IN_PROGRESS status)
   - Include pet and client relations
   - Order by scheduledAt ascending
   - Get photo streak from KimmieStats
   - Render mobile-friendly HTML with:
     - Date header
     - Photo streak badge (if > 0)
     - List of appointments with time, pet name, client name, phone, services
     - Status indicators (emoji)
     - "No appointments" message if empty

3. Create GET /search route with query param `?q=`:
   - Search clients by firstName, lastName, phone (case-insensitive)
   - Include their pets
   - Limit to 20 results
   - Render results as clickable cards showing:
     - Client name and phone
     - List of their pets with species
   - Show search input at top for new searches

4. Style with inline CSS (no external files needed):
   - Use system-ui font
   - Max-width 800px centered
   - Responsive cards with border and padding
   - Purple accent color (#6d28d9) for headers
   - Orange (#f59e0b) for streak badge
  </action>
  <verify>TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`</verify>
  <done>dashboard.ts exports dashboardRouter with /today and /search routes</done>
</task>

<task type="auto">
  <name>Task 3: Mount dashboard router on webhook server</name>
  <files>apps/telegram-bot/src/index.ts</files>
  <action>
Integrate the dashboard into the existing webhook server:

1. Add import at top:
   ```typescript
   import { dashboardRouter } from './routes/dashboard';
   import express from 'express';
   ```

2. Modify the HTTP server creation to use Express:
   - Create Express app: `const app = express();`
   - Add JSON body parser: `app.use(express.json());`
   - Mount dashboard: `app.use('/dashboard', dashboardRouter);`
   - Keep webhook route: `app.post('/webhook', ...)`
   - Keep health check: `app.get('/', ...)`
   - Use app.listen() instead of createServer()

3. The webhook logic stays the same, just wrapped in Express routes.

Note: The existing server already handles Telegram webhooks on /webhook. We're adding /dashboard/* alongside it.
  </action>
  <verify>
1. TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`
2. Router imported: `grep -n "dashboardRouter" apps/telegram-bot/src/index.ts`
3. Express used: `grep -n "express()" apps/telegram-bot/src/index.ts`
  </verify>
  <done>Dashboard accessible at /dashboard/today and /dashboard/search with password protection</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. express-basic-auth installed
3. dashboardRouter exported from routes/dashboard.ts
4. dashboardRouter mounted in index.ts
5. /dashboard/today returns HTML (after auth)
6. /dashboard/search?q=test returns search results
</verification>

<success_criteria>
- Dashboard at /dashboard/today shows today's appointments
- Dashboard at /dashboard/search allows client lookup
- Both routes require basic auth password
- Mobile-friendly (viewport meta, responsive CSS)
- Works alongside existing Telegram webhook on same server
</success_criteria>

<output>
After completion, create `.planning/phases/04-photo-reminders-dashboard/04-03-SUMMARY.md`
</output>
