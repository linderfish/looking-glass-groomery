---
phase: 04-photo-reminders-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/telegram-bot/src/services/streak.ts
  - apps/telegram-bot/src/services/scheduler.ts
  - apps/telegram-bot/src/services/daily-digest.ts
autonomous: true

must_haves:
  truths:
    - "End-of-day reminder fires at 6pm if work day with no photos"
    - "Photo streak counts consecutive work days with photos"
    - "Streak skips non-work days (no appointments)"
    - "Morning digest shows current photo streak"
  artifacts:
    - path: "apps/telegram-bot/src/services/streak.ts"
      provides: "Photo streak calculation logic"
      exports: ["calculatePhotoStreak", "updatePhotoStreak"]
    - path: "apps/telegram-bot/src/services/scheduler.ts"
      provides: "End-of-day photo reminder cron job"
      contains: "checkEndOfDayPhotoReminder"
  key_links:
    - from: "apps/telegram-bot/src/services/scheduler.ts"
      to: "apps/telegram-bot/src/services/streak.ts"
      via: "import calculatePhotoStreak for reminder logic"
      pattern: "calculatePhotoStreak"
    - from: "apps/telegram-bot/src/services/daily-digest.ts"
      to: "apps/telegram-bot/src/services/streak.ts"
      via: "import for streak display"
      pattern: "calculatePhotoStreak"
---

<objective>
Enable end-of-day photo reminders and photo streak tracking so Kimmie never forgets to post groom photos.

Purpose: Core gamification - streaks motivate consistent photo-taking; reminders catch forgotten photos before day ends.
Output: Streak calculation service, enhanced scheduler with 6pm reminder, streak display in morning digest.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-photo-reminders-dashboard/04-RESEARCH.md
@.planning/phases/04-photo-reminders-dashboard/04-01-SUMMARY.md

# Existing infrastructure
@apps/telegram-bot/src/services/scheduler.ts
@apps/telegram-bot/src/services/daily-digest.ts
@apps/telegram-bot/src/services/stats.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create photo streak calculation service</name>
  <files>apps/telegram-bot/src/services/streak.ts</files>
  <action>
Create streak.ts with two functions:

1. `calculatePhotoStreak(): Promise<number>`:
   - Work backwards from yesterday (today doesn't count until end of day)
   - For each day going back:
     - Check if day had any appointments (status: COMPLETED or IN_PROGRESS)
     - If no appointments: skip day (not a work day, doesn't affect streak)
     - If appointments exist: check if any AppointmentPhoto created that day
     - If no photos on work day: streak broken, return current count
     - If photos on work day: increment streak, continue checking
   - Safety limit: stop after 365 days
   - Use startOfDay/endOfDay/subDays from date-fns
   - Return streak count (0 if no streak)

2. `updatePhotoStreak(): Promise<number>`:
   - Called after photo upload to update KimmieStats
   - Calculate current streak
   - Get or create today's KimmieStats record
   - Update photoStreak field
   - Return new streak value

Key rules from RESEARCH.md:
- Non-work days (no appointments) don't break streak
- Only count days with COMPLETED/IN_PROGRESS appointments as work days
- A work day without photos breaks the streak
  </action>
  <verify>TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`</verify>
  <done>streak.ts exports calculatePhotoStreak and updatePhotoStreak functions</done>
</task>

<task type="auto">
  <name>Task 2: Add end-of-day photo reminder to scheduler</name>
  <files>apps/telegram-bot/src/services/scheduler.ts</files>
  <action>
Enhance scheduler.ts to add 6pm photo reminder:

1. Add import for streak service: `import { calculatePhotoStreak } from './streak'`

2. Create `checkEndOfDayPhotoReminder(): Promise<void>`:
   - Get today's date boundaries using Kimmie's timezone
   - Count today's appointments with status COMPLETED or IN_PROGRESS
   - If no appointments today: skip (not a work day, no reminder needed)
   - Count AppointmentPhoto records created today
   - If appointments > 0 but photos === 0:
     - Get current streak for context
     - Send message: "Hey queen! You had {N} appointment(s) today but no photos yet. Don't break that {streak} day streak!"
     - If streak is 0: "Time to start a new streak!"

3. Add to existing cron.schedule callback in initializeScheduler():
   - Check if kimmieTime === '18:00'
   - Call checkEndOfDayPhotoReminder()
   - Add try/catch to not break other scheduler functions

Note: The existing cron job runs every minute and checks kimmieTime. Add the 18:00 check alongside the existing dailySummaryTime check.
  </action>
  <verify>
1. TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`
2. Function exists: `grep -n "checkEndOfDayPhotoReminder" apps/telegram-bot/src/services/scheduler.ts`
3. 18:00 check exists: `grep -n "18:00" apps/telegram-bot/src/services/scheduler.ts`
  </verify>
  <done>Scheduler sends photo reminder at 6pm on work days with no photos</done>
</task>

<task type="auto">
  <name>Task 3: Enhance daily digest with streak display</name>
  <files>apps/telegram-bot/src/services/daily-digest.ts</files>
  <action>
Update daily-digest.ts to use the new streak service:

1. Add import: `import { calculatePhotoStreak } from './streak'`

2. In sendDailyDigest():
   - Replace the existing stats.photoStreak lookup with: `const streak = await calculatePhotoStreak()`
   - Update the streak display message:
     - If streak > 0: "Photo streak: {streak} days! Keep it going!"
     - If streak === 0 and has appointments today: "Start a photo streak today!"

3. In getDailyDigestPreview():
   - Same enhancement: use calculatePhotoStreak() instead of database lookup

This ensures streak is always calculated fresh (accurate) rather than relying on potentially stale database value.
  </action>
  <verify>
1. TypeScript compiles: `cd apps/telegram-bot && npx tsc --noEmit`
2. Import exists: `grep -n "calculatePhotoStreak" apps/telegram-bot/src/services/daily-digest.ts`
  </verify>
  <done>Morning digest shows current photo streak calculated fresh</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. streak.ts exports both functions
3. scheduler.ts has 18:00 check for photo reminder
4. daily-digest.ts imports and uses calculatePhotoStreak
</verification>

<success_criteria>
- Photo streak calculated correctly (skipping non-work days)
- End-of-day reminder fires only on work days with no photos
- Morning digest shows current streak
- Streak updates after photo upload (via updatePhotoStreak)
</success_criteria>

<output>
After completion, create `.planning/phases/04-photo-reminders-dashboard/04-02-SUMMARY.md`
</output>
