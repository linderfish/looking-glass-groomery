---
phase: 01-calendar-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/prisma/schema.prisma
  - apps/cheshire/src/services/calendar-oauth.ts
autonomous: true

must_haves:
  truths:
    - "Appointment model has calendarEventId field that can store Google Calendar event IDs"
    - "Calendar API supports updating existing events by ID"
    - "Calendar API supports deleting events by ID"
  artifacts:
    - path: "packages/db/prisma/schema.prisma"
      provides: "calendarEventId field on Appointment model"
      contains: "calendarEventId"
    - path: "apps/cheshire/src/services/calendar-oauth.ts"
      provides: "updateCalendarEvent and deleteCalendarEvent functions"
      exports: ["updateCalendarEvent", "deleteCalendarEvent"]
  key_links:
    - from: "packages/db/prisma/schema.prisma"
      to: "@prisma/client"
      via: "prisma generate"
      pattern: "calendarEventId.*String"
    - from: "apps/cheshire/src/services/calendar-oauth.ts"
      to: "Google Calendar API v3"
      via: "fetch to googleapis.com/calendar/v3"
      pattern: "calendars.*events"
---

<objective>
Add database field for storing Google Calendar event IDs and implement Calendar API methods for updating and deleting events.

Purpose: Enable full calendar sync lifecycle (create, update, delete) by establishing the data storage and API capabilities required.
Output: Updated Prisma schema with calendarEventId field, calendar-oauth.ts with update/delete methods.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-calendar-sync/01-RESEARCH.md
@packages/db/prisma/schema.prisma
@apps/cheshire/src/services/calendar-oauth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add calendarEventId field to Appointment model</name>
  <files>packages/db/prisma/schema.prisma</files>
  <action>
Add a nullable String field `calendarEventId` to the Appointment model in schema.prisma.

Location: After the `conversationId` field in the Appointment model (around line 232), add:
```prisma
  // Google Calendar sync
  calendarEventId   String?   // Google Calendar event ID for sync operations
```

The field MUST be nullable (String?) because:
1. Existing appointments don't have calendar event IDs
2. Calendar sync can fail - appointment should still be created
3. Allows for appointments created without calendar integration

After editing schema.prisma:
1. Run `npm run db:generate` from project root to regenerate Prisma client
2. Run `npm run db:push` from project root to apply schema change to database

Do NOT attempt to backfill existing records - they will have null values which is correct.
  </action>
  <verify>
1. Run: `grep -n "calendarEventId" packages/db/prisma/schema.prisma` - should show the new field
2. Run: `npm run db:generate` - should complete without errors
3. Run: `npm run db:push` - should apply changes to database
4. Run: `npx prisma studio --browser none` briefly to verify field appears on Appointment model (then Ctrl+C to exit)
  </verify>
  <done>
Appointment model has calendarEventId: String? field, Prisma client regenerated, database schema updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement updateCalendarEvent and deleteCalendarEvent functions</name>
  <files>apps/cheshire/src/services/calendar-oauth.ts</files>
  <action>
Add two new exported functions to calendar-oauth.ts after the existing `createCalendarEvent` function:

**1. updateCalendarEvent function:**
```typescript
/**
 * Update an existing calendar event
 * Uses PUT (full resource update) as Google Calendar API doesn't support PATCH
 */
export async function updateCalendarEvent(
  eventId: string,
  updates: {
    summary: string
    description?: string
    start: Date
    end: Date
  },
  calendarId: string = 'primary'
): Promise<void> {
  const token = await getAccessToken()

  const response = await fetch(
    `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events/${eventId}`,
    {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        summary: updates.summary,
        description: updates.description,
        start: {
          dateTime: updates.start.toISOString(),
          timeZone: 'America/Los_Angeles',
        },
        end: {
          dateTime: updates.end.toISOString(),
          timeZone: 'America/Los_Angeles',
        },
      }),
    }
  )

  if (!response.ok) {
    const error = await response.json().catch(() => ({})) as any
    throw new Error(`Calendar update failed: ${error.error?.message || response.statusText}`)
  }

  console.log(`Updated calendar event: ${eventId}`)
}
```

**2. deleteCalendarEvent function:**
```typescript
/**
 * Delete a calendar event
 * Accepts 404 as success (event already deleted)
 */
export async function deleteCalendarEvent(
  eventId: string,
  calendarId: string = 'primary',
  sendUpdates: 'all' | 'externalOnly' | 'none' = 'none'
): Promise<void> {
  const token = await getAccessToken()

  const params = new URLSearchParams({ sendUpdates })

  const response = await fetch(
    `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events/${eventId}?${params}`,
    {
      method: 'DELETE',
      headers: {
        Authorization: `Bearer ${token}`,
      },
    }
  )

  // 404 is acceptable - event was already deleted
  if (!response.ok && response.status !== 404) {
    const error = await response.json().catch(() => ({})) as any
    throw new Error(`Calendar delete failed: ${error.error?.message || response.statusText}`)
  }

  console.log(`Deleted calendar event: ${eventId}`)
}
```

Key implementation details:
- updateCalendarEvent uses PUT (not PATCH) - Google Calendar API requires full resource replacement
- deleteCalendarEvent accepts 404 as success (idempotent - calling delete twice is safe)
- Both use the existing getAccessToken() for OAuth authentication
- Timezone hardcoded to America/Los_Angeles (Nuevo, CA business location)
- sendUpdates defaults to 'none' to avoid sending calendar notifications to attendees
  </action>
  <verify>
1. Run: `grep -n "updateCalendarEvent\|deleteCalendarEvent" apps/cheshire/src/services/calendar-oauth.ts` - should show both new functions
2. Run: `cd apps/cheshire && npm run build` - should compile without TypeScript errors
3. Visually verify the functions are exported (have `export async function` prefix)
  </verify>
  <done>
calendar-oauth.ts exports updateCalendarEvent() and deleteCalendarEvent() functions that call Google Calendar API v3.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Schema has calendarEventId field: `grep "calendarEventId" packages/db/prisma/schema.prisma`
2. Calendar API methods exist: `grep -E "export async function (update|delete)CalendarEvent" apps/cheshire/src/services/calendar-oauth.ts`
3. Prisma client regenerated: `ls -la packages/db/node_modules/.prisma/client/`
4. Code compiles: `cd apps/cheshire && npm run build`
</verification>

<success_criteria>
1. Appointment model has calendarEventId: String? field in schema.prisma
2. Prisma client has been regenerated with the new field
3. Database schema has been updated (db:push successful)
4. updateCalendarEvent() function exists and is exported from calendar-oauth.ts
5. deleteCalendarEvent() function exists and is exported from calendar-oauth.ts
6. Cheshire app builds without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-calendar-sync/01-01-SUMMARY.md`
</output>
